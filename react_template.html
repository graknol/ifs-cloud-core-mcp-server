<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IFS Cloud Explorer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useCallback } = React;

      function SearchApp() {
        const [query, setQuery] = useState("");
        const [results, setResults] = useState([]);
        const [suggestions, setSuggestions] = useState([]);
        const [stats, setStats] = useState(null);
        const [loading, setLoading] = useState(false);
        const [searchPerformed, setSearchPerformed] = useState(false);
        const [showSuggestions, setShowSuggestions] = useState(false);
        const [selectedSuggestion, setSelectedSuggestion] = useState(-1);
        const [filters, setFilters] = useState({
          file_type: "",
          module: "",
          logical_unit: "",
          limit: 20,
        });

        // Load stats on component mount
        useEffect(() => {
          loadStats();
        }, []);

        const loadStats = async () => {
          try {
            const response = await fetch("/api/stats");
            const data = await response.json();
            setStats(data);
          } catch (error) {
            console.error("Error loading stats:", error);
          }
        };

        const getSuggestions = useCallback(async (searchQuery) => {
          try {
            const response = await fetch("/suggestions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                query: searchQuery,
                limit: 8,
              }),
            });

            if (response.ok) {
              const data = await response.json();
              setSuggestions(data.suggestions || []);
            } else {
              console.warn("Suggestions request failed:", response.status);
              setSuggestions([]);
            }
          } catch (error) {
            console.error("Error getting suggestions:", error);
            setSuggestions([]);
          }
        }, []);

        const handleInput = (e) => {
          const value = e.target.value;
          setQuery(value);

          if (value.length >= 2) {
            getSuggestions(value);
            setShowSuggestions(true);
          } else {
            setSuggestions([]);
            setShowSuggestions(false);
          }
          setSelectedSuggestion(-1);
        };

        const search = async () => {
          if (!query.trim()) return;

          setLoading(true);
          setShowSuggestions(false);

          try {
            const searchData = {
              query: query,
              limit: filters.limit,
            };

            if (filters.file_type) searchData.file_type = filters.file_type;
            if (filters.module) searchData.module = filters.module;
            if (filters.logical_unit)
              searchData.logical_unit = filters.logical_unit;

            const response = await fetch("/search", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(searchData),
            });

            if (response.ok) {
              const data = await response.json();
              setResults(data.results || []);
              setSearchPerformed(true);
            } else {
              const errorText = await response.text();
              console.error("Search failed:", response.status, errorText);
              setResults([]);
            }
          } catch (error) {
            console.error("Search error:", error);
            setResults([]);
          } finally {
            setLoading(false);
          }
        };

        const handleKeyDown = (e) => {
          if (e.key === "Enter") {
            search();
          } else if (e.key === "ArrowDown") {
            e.preventDefault();
            setSelectedSuggestion((prev) =>
              prev < suggestions.length - 1 ? prev + 1 : 0
            );
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            setSelectedSuggestion((prev) =>
              prev > 0 ? prev - 1 : suggestions.length - 1
            );
          } else if (e.key === "Escape") {
            setShowSuggestions(false);
          }
        };

        const selectSuggestion = (suggestion) => {
          setQuery(suggestion.text);
          setShowSuggestions(false);
          setTimeout(() => search(), 100);
        };

        const updateFilter = (key, value) => {
          setFilters((prev) => ({ ...prev, [key]: value }));
        };

        return (
          <div className="container mx-auto px-4 py-8">
            {/* Header */}
            <div className="mb-8">
              <h1 className="text-4xl font-bold text-gray-900 mb-2">
                <i className="fas fa-search text-blue-600"></i> IFS Cloud
                Explorer
              </h1>
              <p className="text-gray-600">
                Intelligent search for IFS Cloud codebases with frontend element
                discovery
              </p>
            </div>

            {/* Search Section */}
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <div className="relative">
                {/* Search Input */}
                <div className="relative">
                  <input
                    type="text"
                    value={query}
                    onChange={handleInput}
                    onKeyDown={handleKeyDown}
                    onFocus={() => setShowSuggestions(true)}
                    placeholder="Search entities, functions, pages, iconsets, trees, navigators..."
                    className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                  />
                  <i className="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                  <button
                    onClick={search}
                    className="absolute right-2 top-2 bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700"
                  >
                    Search
                  </button>
                </div>

                {/* Type-ahead Suggestions */}
                {showSuggestions && suggestions.length > 0 && (
                  <div className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-64 overflow-y-auto shadow-lg">
                    {suggestions.map((suggestion, index) => (
                      <div
                        key={index}
                        onClick={() => selectSuggestion(suggestion)}
                        className={`px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0 ${
                          selectedSuggestion === index ? "bg-blue-50" : ""
                        }`}
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <span className="font-medium">
                              {suggestion.text}
                            </span>
                            <span className="text-sm text-gray-500 ml-2">
                              {suggestion.context}
                            </span>
                          </div>
                          <span
                            className={`px-2 py-1 rounded text-xs font-medium ${
                              suggestion.type === "entity"
                                ? "bg-blue-100 text-blue-800"
                                : suggestion.type === "file"
                                ? "bg-green-100 text-green-800"
                                : suggestion.type === "module"
                                ? "bg-purple-100 text-purple-800"
                                : "bg-orange-100 text-orange-800"
                            }`}
                          >
                            {suggestion.type}
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Filters */}
              <div className="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <select
                  value={filters.file_type}
                  onChange={(e) => updateFilter("file_type", e.target.value)}
                  className="border border-gray-300 rounded px-3 py-2"
                >
                  <option value="">All File Types</option>
                  <option value=".entity">Entity</option>
                  <option value=".client">Client</option>
                  <option value=".projection">Projection</option>
                  <option value=".fragment">Fragment</option>
                  <option value=".plsql">PL/SQL</option>
                  <option value=".views">Views</option>
                  <option value=".storage">Storage</option>
                </select>

                <input
                  value={filters.module}
                  onChange={(e) => updateFilter("module", e.target.value)}
                  placeholder="Module filter..."
                  className="border border-gray-300 rounded px-3 py-2"
                />
                <input
                  value={filters.logical_unit}
                  onChange={(e) => updateFilter("logical_unit", e.target.value)}
                  placeholder="Logical Unit filter..."
                  className="border border-gray-300 rounded px-3 py-2"
                />
                <input
                  type="number"
                  value={filters.limit}
                  onChange={(e) =>
                    updateFilter("limit", parseInt(e.target.value) || 20)
                  }
                  placeholder="Result limit..."
                  className="border border-gray-300 rounded px-3 py-2"
                />
              </div>
            </div>

            {/* Stats */}
            {stats && (
              <div className="bg-white rounded-lg shadow-md p-4 mb-6">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                  <div>
                    <div className="text-2xl font-bold text-blue-600">
                      {stats.total_files || 0}
                    </div>
                    <div className="text-sm text-gray-600">Files Indexed</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-green-600">
                      {stats.total_entities || 0}
                    </div>
                    <div className="text-sm text-gray-600">Entities</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-purple-600">
                      {stats.supported_extensions?.length || 0}
                    </div>
                    <div className="text-sm text-gray-600">File Types</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-orange-600">
                      {results.length}
                    </div>
                    <div className="text-sm text-gray-600">Results</div>
                  </div>
                </div>
              </div>
            )}

            {/* Loading */}
            {loading && (
              <div className="text-center py-8">
                <i className="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
                <p className="mt-2 text-gray-600">Searching...</p>
              </div>
            )}

            {/* Results */}
            {results.length > 0 && !loading && (
              <div className="space-y-4">
                {results.map((result, index) => (
                  <div
                    key={index}
                    className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
                  >
                    {/* File Header */}
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900">
                          {result.name}
                        </h3>
                        <p className="text-sm text-gray-600">{result.path}</p>
                      </div>
                      <div className="flex items-center space-x-2">
                        <span className="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-medium">
                          {result.type}
                        </span>
                        <span className="text-sm text-gray-500">
                          Score: {result.score?.toFixed(3) || "0"}
                        </span>
                      </div>
                    </div>

                    {/* Tags */}
                    {result.tags && result.tags.length > 0 && (
                      <div className="mb-3">
                        {result.tags.map((tag, tagIndex) => (
                          <span
                            key={tagIndex}
                            className="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium mr-1 mb-1"
                          >
                            {tag}
                          </span>
                        ))}
                      </div>
                    )}

                    {/* IFS Context */}
                    {(result.module ||
                      result.logical_unit ||
                      result.component) && (
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3 text-sm">
                        {result.module && (
                          <div>
                            <span className="font-medium text-gray-700">
                              Module:
                            </span>{" "}
                            {result.module}
                          </div>
                        )}
                        {result.logical_unit && (
                          <div>
                            <span className="font-medium text-gray-700">
                              Logical Unit:
                            </span>{" "}
                            {result.logical_unit}
                          </div>
                        )}
                        {result.component && (
                          <div>
                            <span className="font-medium text-gray-700">
                              Component:
                            </span>{" "}
                            {result.component}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Frontend Elements */}
                    {(result.pages?.length > 0 ||
                      result.iconsets?.length > 0 ||
                      result.trees?.length > 0 ||
                      result.navigators?.length > 0) && (
                      <div className="mb-3">
                        <h4 className="font-medium text-gray-700 mb-2">
                          Frontend Elements:
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                          {result.pages && result.pages.length > 0 && (
                            <div>
                              <span className="font-medium text-blue-600">
                                Pages:
                              </span>{" "}
                              {result.pages.join(", ")}
                            </div>
                          )}
                          {result.lists && result.lists.length > 0 && (
                            <div>
                              <span className="font-medium text-green-600">
                                Lists:
                              </span>{" "}
                              {result.lists.join(", ")}
                            </div>
                          )}
                          {result.iconsets && result.iconsets.length > 0 && (
                            <div>
                              <span className="font-medium text-purple-600">
                                Iconsets:
                              </span>{" "}
                              {result.iconsets.join(", ")}
                            </div>
                          )}
                          {result.trees && result.trees.length > 0 && (
                            <div>
                              <span className="font-medium text-orange-600">
                                Trees:
                              </span>{" "}
                              {result.trees.join(", ")}
                            </div>
                          )}
                          {result.navigators &&
                            result.navigators.length > 0 && (
                              <div>
                                <span className="font-medium text-red-600">
                                  Navigators:
                                </span>{" "}
                                {result.navigators.join(", ")}
                              </div>
                            )}
                        </div>
                      </div>
                    )}

                    {/* Entities */}
                    {result.entities && result.entities.length > 0 && (
                      <div className="mb-3">
                        <span className="font-medium text-gray-700">
                          Entities:
                        </span>{" "}
                        <span className="text-sm">
                          {result.entities.join(", ")}
                        </span>
                      </div>
                    )}

                    {/* Content Preview */}
                    <div className="bg-gray-50 rounded p-3">
                      <pre
                        className="text-sm text-gray-700 whitespace-pre-wrap"
                        dangerouslySetInnerHTML={{
                          __html: result.highlight || result.content_preview,
                        }}
                      ></pre>
                    </div>

                    {/* Metadata */}
                    <div className="mt-3 flex justify-between text-xs text-gray-500">
                      <span>Lines: {result.line_count}</span>
                      <span>
                        Complexity: {result.complexity_score?.toFixed(2) || "0"}
                      </span>
                      <span>
                        Modified:{" "}
                        {result.modified_time
                          ? new Date(result.modified_time).toLocaleDateString()
                          : "N/A"}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* No Results */}
            {results.length === 0 && searchPerformed && !loading && (
              <div className="text-center py-8">
                <i className="fas fa-search text-4xl text-gray-400 mb-4"></i>
                <h3 className="text-lg font-medium text-gray-900 mb-2">
                  No results found
                </h3>
                <p className="text-gray-600">
                  Try adjusting your search terms or filters
                </p>
              </div>
            )}
          </div>
        );
      }

      // Render the app
      ReactDOM.render(<SearchApp />, document.getElementById("root"));
    </script>
  </body>
</html>
