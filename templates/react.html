<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IFS Cloud Explorer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- CodeMirror CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/codemirror@5.65.16/lib/codemirror.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/codemirror@5.65.16/theme/default.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/codemirror@5.65.16/theme/material-darker.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/codemirror@5.65.16/addon/dialog/dialog.css"
    />
    <!-- IFS Cloud Marble Dark Theme -->
    <link rel="stylesheet" href="/static/css/codemirror-marble-dark.css" />

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- CodeMirror JS -->
    <script src="https://unpkg.com/codemirror@5.65.16/lib/codemirror.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/sql/sql.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/javascript/javascript.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/xml/xml.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/css/css.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/mode/clike/clike.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/addon/search/searchcursor.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/addon/search/search.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.16/addon/dialog/dialog.js"></script>
    <!-- IFS Cloud Marble Language Mode -->
    <script src="/static/js/codemirror-marble-mode.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      {% raw %}
        const { useState, useEffect, useCallback, useRef } = React;

        // Reusable AutocompleteInput component
        function AutocompleteInput({
          value,
          onChange,
          onSelect,
          onEnterKey,
          placeholder,
          getSuggestions,
          containerClassName = "",
          inputClassName = "w-full border border-gray-300 rounded px-3 py-2",
        }) {
          const [showSuggestions, setShowSuggestions] = useState(false);
          const [selectedSuggestion, setSelectedSuggestion] = useState(-1);
          const [internalSuggestions, setInternalSuggestions] = useState([]);

          const handleInput = (e) => {
            const inputValue = e.target.value;
            onChange(inputValue);

            if (inputValue.length >= 1) {
              const filtered = getSuggestions(inputValue);
              setInternalSuggestions(filtered);
              setShowSuggestions(filtered.length > 0);
            } else {
              setInternalSuggestions([]);
              setShowSuggestions(false);
            }
            setSelectedSuggestion(-1);
          };

          const handleKeyDown = (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              if (selectedSuggestion >= 0 && internalSuggestions[selectedSuggestion]) {
                selectSuggestion(internalSuggestions[selectedSuggestion]);
              } else if (onEnterKey) {
                // No suggestion selected, trigger the onEnterKey callback (e.g., search)
                onEnterKey();
              }
            } else if (e.key === "ArrowDown") {
              e.preventDefault();
              if (showSuggestions && internalSuggestions.length > 0) {
                setSelectedSuggestion((prev) =>
                  prev < internalSuggestions.length - 1 ? prev + 1 : 0
                );
              }
            } else if (e.key === "ArrowUp") {
              e.preventDefault();
              if (showSuggestions && internalSuggestions.length > 0) {
                setSelectedSuggestion((prev) =>
                  prev > 0 ? prev - 1 : internalSuggestions.length - 1
                );
              }
            } else if (e.key === "Escape") {
              e.preventDefault();
              setShowSuggestions(false);
              setSelectedSuggestion(-1);
            }
          };

          const selectSuggestion = (suggestion) => {
            onSelect(suggestion.text);
            setShowSuggestions(false);
            setSelectedSuggestion(-1);
          };

          // Handle click outside
          useEffect(() => {
            const handleClickOutside = (event) => {
              const container = event.target.closest(`.${containerClassName}`);
              if (!container) {
                setShowSuggestions(false);
              }
            };

            document.addEventListener("mousedown", handleClickOutside);
            return () => {
              document.removeEventListener("mousedown", handleClickOutside);
            };
          }, [containerClassName]);

          return (
            <div className={`relative ${containerClassName}`}>
              <input
                type="text"
                value={value}
                onChange={handleInput}
                onKeyDown={handleKeyDown}
                onFocus={() => value.length >= 1 && setShowSuggestions(true)}
                placeholder={placeholder}
                className={inputClassName}
              />
              {showSuggestions && internalSuggestions.length > 0 && (
                <div className="absolute z-20 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg">
                  {internalSuggestions.map((suggestion, index) => (
                    <div
                      key={index}
                      onClick={() => selectSuggestion(suggestion)}
                      className={`px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0 ${
                        selectedSuggestion === index ? "bg-blue-50" : ""
                      }`}
                    >
                      <span className="font-medium">{suggestion.text}</span>
                      <span className="text-sm text-gray-500 ml-2">
                        {suggestion.context}
                      </span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          );
        }

        // CodeMirror wrapper component
        function CodeViewer({ content, filePath, hasSearchHighlights }) {
          const editorRef = useRef(null);
          const codeMirrorRef = useRef(null);

          // Determine file type based on extension
          const getMode = (filePath) => {
            const extension = filePath?.split('.').pop()?.toLowerCase();
            switch (extension) {
              case 'js': case 'jsx': return 'javascript';
              case 'sql': case 'views': case 'storage': return 'sql';
              case 'plsql': return 'text/x-plsql';
              case 'client': case 'fragment': case 'projection': return 'marble';
              case 'xml': case 'html': case 'entity': return 'xml';
              case 'css': return 'css';
              case 'java': case 'c': case 'cpp': case 'h': return 'clike';
              default: return 'text/plain';
            }
          };

          useEffect(() => {
            if (editorRef.current && !codeMirrorRef.current) {
              try {
                // Initialize CodeMirror
                codeMirrorRef.current = CodeMirror(editorRef.current, {
                  value: content || '',
                  mode: getMode(filePath),
                  theme: 'marble-dark',
                  lineNumbers: true,
                  readOnly: true,
                  lineWrapping: true,
                  matchBrackets: true,
                  autoCloseBrackets: true,
                  foldGutter: true,
                  gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                  viewportMargin: 50, // Changed from Infinity to improve scrolling
                  extraKeys: {
                    "Ctrl-F": "findPersistent",
                    "Cmd-F": "findPersistent"
                  }
                });

                // Set proper size with scrolling - calculate 60% of viewport height minus header/footer
                const viewportHeight = window.innerHeight;
                const maxEditorHeight = Math.floor(viewportHeight * 0.6 * 0.7); // 60vh modal * 70% for editor
                codeMirrorRef.current.setSize("100%", `${maxEditorHeight}px`);

                // Force refresh to ensure proper sizing
                setTimeout(() => {
                  if (codeMirrorRef.current && typeof codeMirrorRef.current.refresh === 'function') {
                    codeMirrorRef.current.refresh();
                    codeMirrorRef.current.scrollTo(0, 0);
                  }
                }, 50);
              } catch (error) {
                console.error('Error initializing CodeMirror:', error);
              }
            }

            // Update content when it changes
            if (codeMirrorRef.current && content !== undefined && typeof codeMirrorRef.current.getValue === 'function') {
              try {
                const currentValue = codeMirrorRef.current.getValue();
                if (currentValue !== content) {
                  codeMirrorRef.current.setValue(content || '');
                  // Force refresh to ensure proper sizing and scrollbars
                  setTimeout(() => {
                    if (codeMirrorRef.current && typeof codeMirrorRef.current.refresh === 'function') {
                      codeMirrorRef.current.refresh();
                    }
                  }, 10);
                }
              } catch (error) {
                console.error('Error updating CodeMirror content:', error);
              }
            }
          }, [content, filePath]);

          // Cleanup on unmount
          useEffect(() => {
            return () => {
              if (codeMirrorRef.current && typeof codeMirrorRef.current.toTextArea === 'function') {
                try {
                  codeMirrorRef.current.toTextArea();
                } catch (error) {
                  console.warn('Error cleaning up CodeMirror:', error);
                }
                codeMirrorRef.current = null;
              }
            };
          }, []);

          return (
            <div className="h-full flex flex-col overflow-hidden">
              <div
                ref={editorRef}
                className="flex-1 overflow-hidden"
                style={{
                  height: '100%',
                  maxHeight: '100%',
                  minHeight: 0
                }}
              />
            </div>
          );
        }

        function SearchApp() {
          const [query, setQuery] = useState("");
          const [results, setResults] = useState([]);
          const [suggestions, setSuggestions] = useState([]);
          const [stats, setStats] = useState(null);
          const [loading, setLoading] = useState(false);
          const [searchPerformed, setSearchPerformed] = useState(false);
          const [showSuggestions, setShowSuggestions] = useState(false);
          const [selectedSuggestion, setSelectedSuggestion] = useState(-1);

          // Filter states - simplified
          const [moduleQuery, setModuleQuery] = useState("");
          const [logicalUnitQuery, setLogicalUnitQuery] = useState("");

          const [filters, setFilters] = useState({
            file_type: "",
            module: "",
            logical_unit: "",
            limit: 20,
          });

          // Search metrics state
          const [searchMetrics, setSearchMetrics] = useState({
            lastSearchTime: null,
            searchDuration: null,
            activeFilters: [],
          });

          // Suggestion generation functions
          const getModuleSuggestions = (inputValue) => {
            if (!stats || !stats.modules) return [];
            return stats.modules
              .filter((module) =>
                module.toLowerCase().includes(inputValue.toLowerCase())
              )
              .slice(0, 10)
              .map((module) => ({ text: module, context: `Module` }));
          };

          const getLogicalUnitSuggestions = (inputValue) => {
            console.log("GET LOGIAL UT");
            if (!stats || !stats.logical_units) return [];
            return stats.logical_units
              .filter((lu) => lu.toLowerCase().includes(inputValue.toLowerCase()))
              .slice(0, 10)
              .map((lu) => ({ text: lu, context: `Logical Unit` }));
          };

          const generateMainSuggestions = (inputValue) => {
            const suggestions = [];

            if (stats) {
              // Add matching modules
              const matchingModules = stats.modules
                .filter((module) =>
                  module.toLowerCase().includes(inputValue.toLowerCase())
                )
                .slice(0, 3)
                .map((module) => ({ text: module, context: "Module" }));
              suggestions.push(...matchingModules);

              // Add matching logical units
              const matchingLogicalUnits = stats.logical_units
                .filter((lu) =>
                  lu.toLowerCase().includes(inputValue.toLowerCase())
                )
                .slice(0, 3)
                .map((lu) => ({ text: lu, context: "Logical Unit" }));
              suggestions.push(...matchingLogicalUnits);
            }

            return suggestions.slice(0, 6);
          };
          console.log("RENDER");

          const [fileViewerState, setFileViewerState] = useState({
            isOpen: false,
            filePath: null,
            filename: null,
            content: null,
            metadata: null,
            loading: false,
            error: null,
            hasSearchHighlights: false,
          });

          // Load stats on component mount
          useEffect(() => {
            fetchStats();
          }, []);

          // Handle clicking outside suggestions to close dropdown (main search only)
          useEffect(() => {
            const handleClickOutside = (event) => {
              // Check if click is outside the search container
              const searchContainer = event.target.closest(".search-container");
              if (!searchContainer) {
                setShowSuggestions(false);
              }
            };

            document.addEventListener("mousedown", handleClickOutside);
            return () => {
              document.removeEventListener("mousedown", handleClickOutside);
            };
          }, []);

          // Handle keyboard events for modal and suggestions
          useEffect(() => {
            const handleKeyDown = (event) => {
              // Close file viewer modal with Escape key
              if (event.key === "Escape" && fileViewerState.isOpen) {
                closeFileViewer();
                event.preventDefault();
                return;
              }

              // Close suggestions with Escape key
              if (event.key === "Escape" && showSuggestions) {
                setShowSuggestions(false);
                setSelectedSuggestion(-1);
                event.preventDefault();
                return;
              }
            };

            document.addEventListener("keydown", handleKeyDown);
            return () => {
              document.removeEventListener("keydown", handleKeyDown);
            };
          }, [fileViewerState.isOpen, showSuggestions]);

          const fetchStats = async () => {
            try {
              const response = await fetch("/api/stats");
              const data = await response.json();
              setStats(data);
            } catch (error) {
              console.error("Error loading stats:", error);
            }
          };

          const getSuggestions = useCallback(async (searchQuery) => {
            try {
              const response = await fetch("/suggestions", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  query: searchQuery,
                  limit: 8,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                setSuggestions(data.suggestions || []);
              } else {
                console.warn("Suggestions request failed:", response.status);
                setSuggestions([]);
              }
            } catch (error) {
              console.error("Error getting suggestions:", error);
              setSuggestions([]);
            }
          }, []);

          // Main search handlers for the legacy input
          const handleMainInput = (value) => {
            setQuery(value);
            if (value.length >= 2) {
              const newSuggestions = generateMainSuggestions(value);
              setSuggestions(newSuggestions);
              setShowSuggestions(newSuggestions.length > 0);
            } else {
              setSuggestions([]);
              setShowSuggestions(false);
            }
            setSelectedSuggestion(-1);
          };

          const selectMainSuggestion = (suggestionText) => {
            setQuery(suggestionText);
            // Clear the suggestions
            setSuggestions([]);
            setShowSuggestions(false);
            setSelectedSuggestion(-1);
            // Trigger search after a brief delay
            setTimeout(() => search(), 100);
          };

          // Filter update handlers
          const handleModuleChange = (moduleValue) => {
            setModuleQuery(moduleValue);
            updateFilter("module", moduleValue);
          };

          const handleModuleSelect = (moduleValue) => {
            setModuleQuery(moduleValue);
            updateFilter("module", moduleValue);
          };

          const handleLogicalUnitChange = (logicalUnitValue) => {
            setLogicalUnitQuery(logicalUnitValue);
            updateFilter("logical_unit", logicalUnitValue);
          };

          const handleLogicalUnitSelect = (logicalUnitValue) => {
            setLogicalUnitQuery(logicalUnitValue);
            updateFilter("logical_unit", logicalUnitValue);
          };

          const search = async () => {
            if (!query.trim()) {
              setResults([]);
              setSearchPerformed(false);
              setSearchMetrics({
                lastSearchTime: null,
                searchDuration: null,
                activeFilters: [],
              });
              return;
            }

            setLoading(true);
            setShowSuggestions(false);
            const searchStartTime = Date.now();

            try {
              const searchData = {
                query: query,
                limit: filters.limit,
              };

              if (filters.file_type) searchData.file_type = filters.file_type;
              if (filters.module) searchData.module = filters.module;
              if (filters.logical_unit)
                searchData.logical_unit = filters.logical_unit;

              // Track active filters
              const activeFilters = [];
              if (filters.file_type) activeFilters.push(`File Type: ${filters.file_type}`);
              if (filters.module) activeFilters.push(`Module: ${filters.module}`);
              if (filters.logical_unit) activeFilters.push(`Logical Unit: ${filters.logical_unit}`);

              const response = await fetch("/search", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(searchData),
              });

              if (response.ok) {
                const data = await response.json();
                setResults(data.results || []);
                setSearchPerformed(true);

                // Update search metrics
                const searchEndTime = Date.now();
                setSearchMetrics({
                  lastSearchTime: new Date().toLocaleTimeString(),
                  searchDuration: searchEndTime - searchStartTime,
                  activeFilters: activeFilters,
                });
              } else {
                const errorText = await response.text();
                console.error("Search failed:", response.status, errorText);
                setResults([]);
              }
            } catch (error) {
              console.error("Search error:", error);
              setResults([]);
            } finally {
              setLoading(false);
            }
          };

          // Debounced search effect
          useEffect(() => {
            const timeoutId = setTimeout(() => {
              search();
            }, 500); // 500ms debounce delay

            return () => clearTimeout(timeoutId);
          }, [query, filters.file_type, filters.module, filters.logical_unit, filters.limit]);

          const updateFilter = (key, value) => {
            setFilters((prev) => ({ ...prev, [key]: value }));
          };

          const clearFilter = (filterType) => {
            switch (filterType) {
              case 'file_type':
                setFilters((prev) => ({ ...prev, file_type: "" }));
                break;
              case 'module':
                setFilters((prev) => ({ ...prev, module: "" }));
                setModuleQuery("");
                break;
              case 'logical_unit':
                setFilters((prev) => ({ ...prev, logical_unit: "" }));
                setLogicalUnitQuery("");
                break;
              default:
                break;
            }
          };

          const handleFilterBadgeClick = (filterText) => {
            // Parse the filter text to determine which filter to clear
            if (filterText.startsWith("File Type:")) {
              clearFilter('file_type');
            } else if (filterText.startsWith("Module:")) {
              clearFilter('module');
            } else if (filterText.startsWith("Logical Unit:")) {
              clearFilter('logical_unit');
            }
          };

          const setFilterFromResult = (filterType, value) => {
            if (filterType === 'module') {
              setFilters((prev) => ({ ...prev, module: value }));
              setModuleQuery(value);
            } else if (filterType === 'logical_unit') {
              setFilters((prev) => ({ ...prev, logical_unit: value }));
              setLogicalUnitQuery(value);
            }
          };

          const openFileViewer = async (filePath, searchQuery = "") => {
            const filename = filePath.split("/").pop() || filePath;

            setFileViewerState({
              isOpen: true,
              filePath: filePath,
              filename: filename,
              content: null,
              metadata: null,
              loading: true,
              error: null,
              hasSearchHighlights: !!searchQuery,
            });

            try {
              const url = searchQuery
                ? `/api/file/${encodeURIComponent(
                    filePath
                  )}?search_query=${encodeURIComponent(searchQuery)}`
                : `/api/file/${encodeURIComponent(filePath)}`;

              const response = await fetch(url);

              if (response.ok) {
                const data = await response.json();
                setFileViewerState((prev) => ({
                  ...prev,
                  content: searchQuery ? data.highlighted_content : data.content,
                  metadata: {
                    line_count: data.lines,
                    file_type: data.type,
                    modified_time: data.modified_time,
                    size: data.size,
                    match_count: data.match_count,
                  },
                  loading: false,
                }));
              } else {
                setFileViewerState((prev) => ({
                  ...prev,
                  error: `Failed to load file: ${response.status} ${response.statusText}`,
                  loading: false,
                }));
              }
            } catch (error) {
              console.error("Error loading file:", error);
              setFileViewerState((prev) => ({
                ...prev,
                error: "Error loading file content",
                loading: false,
              }));
            }
          };

          const closeFileViewer = () => {
            setFileViewerState({
              isOpen: false,
              filePath: null,
              filename: null,
              content: null,
              metadata: null,
              loading: false,
              error: null,
              hasSearchHighlights: false,
            });
          };

          return (
            <div className="container mx-auto px-4 py-8">
              {/* Header */}
              <div className="mb-8">
                <h1 className="text-4xl font-bold text-gray-900 mb-2">
                  <i className="fas fa-search text-blue-600"></i> IFS Cloud
                  Explorer
                </h1>
                <p className="text-gray-600">
                  Intelligent search for IFS Cloud codebases with frontend element
                  discovery
                </p>
              </div>

              {/* Search Section */}
              <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                <div className="relative search-container">
                  {/* Search Input */}
                  <div className="relative">
                    <AutocompleteInput
                      value={query}
                      onChange={handleMainInput}
                      onSelect={selectMainSuggestion}
                      onEnterKey={() => {}} // No longer needed since we have auto-search
                      placeholder="Search entities, functions, pages, iconsets, trees, navigators..."
                      suggestions={suggestions}
                      getSuggestions={generateMainSuggestions}
                      containerClassName="search-input-container"
                      inputClassName="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                    />
                    <i className="fas fa-search absolute left-4 top-4 text-gray-400 pointer-events-none z-10"></i>
                  </div>
                </div>

                {/* Filters */}
                <div className="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                  <select
                    value={filters.file_type}
                    onChange={(e) => updateFilter("file_type", e.target.value)}
                    className="border border-gray-300 rounded px-3 py-2"
                  >
                    <option value="">All File Types</option>
                    <option value=".entity">Entity</option>
                    <option value=".client">Client</option>
                    <option value=".projection">Projection</option>
                    <option value=".fragment">Fragment</option>
                    <option value=".plsql">PL/SQL</option>
                    <option value=".views">Views</option>
                    <option value=".storage">Storage</option>
                  </select>

                  {/* Module Autocomplete */}
                  <AutocompleteInput
                    value={moduleQuery}
                    onChange={handleModuleChange}
                    onSelect={handleModuleSelect}
                    placeholder="Filter by module..."
                    getSuggestions={getModuleSuggestions}
                    containerClassName="module-filter-container"
                  />

                  {/* Logical Unit Autocomplete */}
                  <AutocompleteInput
                    value={logicalUnitQuery}
                    onChange={handleLogicalUnitChange}
                    onSelect={handleLogicalUnitSelect}
                    placeholder="Filter by logical unit..."
                    getSuggestions={getLogicalUnitSuggestions}
                    containerClassName="logical-unit-filter-container"
                  />

                  <input
                    type="number"
                    value={filters.limit}
                    onChange={(e) =>
                      updateFilter("limit", parseInt(e.target.value) || 20)
                    }
                    placeholder="Result limit..."
                    className="border border-gray-300 rounded px-3 py-2"
                  />
                </div>
              </div>

              {/* Search Context Stats */}
              {(searchPerformed || stats) && (
                <div className="bg-white rounded-lg shadow-md p-4 mb-6">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    {/* Total Files Indexed */}
                    <div>
                      <div className="text-2xl font-bold text-blue-600">
                        {stats?.total_files || 0}
                      </div>
                      <div className="text-sm text-gray-600">Files Indexed</div>
                    </div>

                    {/* Results Found */}
                    <div>
                      <div className="text-2xl font-bold text-green-600">
                        {results.length}
                      </div>
                      <div className="text-sm text-gray-600">Results Found</div>
                    </div>

                    {/* Search Duration */}
                    <div>
                      <div className="text-2xl font-bold text-purple-600">
                        {searchMetrics.searchDuration ? `${searchMetrics.searchDuration}ms` : "—"}
                      </div>
                      <div className="text-sm text-gray-600">Search Time</div>
                    </div>

                    {/* Available Context */}
                    <div>
                      <div className="text-2xl font-bold text-orange-600">
                        {stats ? `${stats.modules?.length || 0}/${stats.logical_units?.length || 0}` : "—"}
                      </div>
                      <div className="text-sm text-gray-600">Modules/LUs</div>
                    </div>
                  </div>

                  {/* Active Filters */}
                  {searchMetrics.activeFilters && searchMetrics.activeFilters.length > 0 && (
                    <div className="mt-4 pt-3 border-t border-gray-200">
                      <div className="text-sm text-gray-600 mb-2">Active Filters:</div>
                      <div className="flex flex-wrap gap-2">
                        {searchMetrics.activeFilters.map((filter, index) => (
                          <span
                            key={index}
                            className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs cursor-pointer hover:bg-blue-200 hover:text-blue-900 transition-colors duration-200 flex items-center gap-1"
                            onClick={() => handleFilterBadgeClick(filter)}
                            title="Click to clear this filter"
                          >
                            {filter}
                            <svg className="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                            </svg>
                          </span>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Last Search Time */}
                  {searchMetrics.lastSearchTime && (
                    <div className="mt-2 text-center">
                      <div className="text-xs text-gray-500">
                        Last search: {searchMetrics.lastSearchTime}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Loading */}
              {loading && (
                <div className="text-center py-8">
                  <i className="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
                  <p className="mt-2 text-gray-600">Searching...</p>
                </div>
              )}

              {/* Results */}
              {results.length > 0 && !loading && (
                <div className="space-y-4">
                  {results.map((result, index) => (
                    <div
                      key={index}
                      className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
                    >
                      {/* File Header */}
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex-1">
                          <h3 className="text-lg font-semibold text-gray-900 mb-1">
                            {result.name}
                          </h3>
                          <p className="text-sm text-gray-600 mb-2">
                            {result.path}
                          </p>

                          {/* Action Buttons */}
                          <div className="flex space-x-2">
                            <button
                              onClick={() => openFileViewer(result.path, query)}
                              className="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors"
                            >
                              <i className="fas fa-eye mr-1"></i>
                              View File
                            </button>
                            <button
                              onClick={() => openFileViewer(result.path)}
                              className="text-xs bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700 transition-colors"
                            >
                              <i className="fas fa-code mr-1"></i>
                              Raw
                            </button>
                          </div>
                        </div>
                        <div className="flex items-center space-x-2">
                          <span className="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-medium">
                            {result.type}
                          </span>
                          <span className="text-sm text-gray-500">
                            Score: {result.score?.toFixed(1) || "0"}
                          </span>
                        </div>
                      </div>

                      {/* Tags */}
                      {result.tags && result.tags.length > 0 && (
                        <div className="mb-3">
                          {result.tags.map((tag, tagIndex) => (
                            <span
                              key={tagIndex}
                              className="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium mr-1 mb-1"
                            >
                              {tag}
                            </span>
                          ))}
                        </div>
                      )}

                      {/* IFS Context */}
                      {(result.module ||
                        result.logical_unit ||
                        result.component) && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3 text-sm">
                          {result.module && (
                            <div className="flex items-center gap-2">
                              <span className="font-medium text-gray-700">
                                Module:
                              </span>
                              <span
                                className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs cursor-pointer hover:bg-blue-200 hover:text-blue-900 transition-colors duration-200"
                                onClick={() => setFilterFromResult('module', result.module)}
                                title="Click to filter by this module"
                              >
                                {result.module}
                              </span>
                            </div>
                          )}
                          {result.logical_unit && (
                            <div className="flex items-center gap-2">
                              <span className="font-medium text-gray-700">
                                Logical Unit:
                              </span>
                              <span
                                className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs cursor-pointer hover:bg-green-200 hover:text-green-900 transition-colors duration-200"
                                onClick={() => setFilterFromResult('logical_unit', result.logical_unit)}
                                title="Click to filter by this logical unit"
                              >
                                {result.logical_unit}
                              </span>
                            </div>
                          )}
                          {result.component && (
                            <div>
                              <span className="font-medium text-gray-700">
                                Component:
                              </span>{" "}
                              {result.component}
                            </div>
                          )}
                        </div>
                      )}

                      {/* Frontend Elements */}
                      {(result.pages?.length > 0 ||
                        result.iconsets?.length > 0 ||
                        result.trees?.length > 0 ||
                        result.navigators?.length > 0) && (
                        <div className="mb-3">
                          <h4 className="font-medium text-gray-700 mb-2">
                            Frontend Elements:
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            {result.pages && result.pages.length > 0 && (
                              <div>
                                <span className="font-medium text-blue-600">
                                  Pages:
                                </span>{" "}
                                {result.pages.join(", ")}
                              </div>
                            )}
                            {result.lists && result.lists.length > 0 && (
                              <div>
                                <span className="font-medium text-green-600">
                                  Lists:
                                </span>{" "}
                                {result.lists.join(", ")}
                              </div>
                            )}
                            {result.iconsets && result.iconsets.length > 0 && (
                              <div>
                                <span className="font-medium text-purple-600">
                                  Iconsets:
                                </span>{" "}
                                {result.iconsets.join(", ")}
                              </div>
                            )}
                            {result.trees && result.trees.length > 0 && (
                              <div>
                                <span className="font-medium text-orange-600">
                                  Trees:
                                </span>{" "}
                                {result.trees.join(", ")}
                              </div>
                            )}
                            {result.navigators &&
                              result.navigators.length > 0 && (
                                <div>
                                  <span className="font-medium text-red-600">
                                    Navigators:
                                  </span>{" "}
                                  {result.navigators.join(", ")}
                                </div>
                              )}
                          </div>
                        </div>
                      )}

                      {/* Entities */}
                      {result.entities && result.entities.length > 0 && (
                        <div className="mb-3">
                          <span className="font-medium text-gray-700">
                            Entities:
                          </span>{" "}
                          <span className="text-sm">
                            {result.entities.join(", ")}
                          </span>
                        </div>
                      )}

                      {/* Content Preview - Compact */}
                      <div className="border-t pt-2 mt-2">
                        <div className="text-xs text-gray-500 mb-1 flex items-center">
                          <i className="fas fa-search mr-1"></i>
                          Preview
                        </div>
                        <div
                          className="text-sm text-gray-700 max-h-16 overflow-hidden"
                          style={{
                            display: "-webkit-box",
                            WebkitLineClamp: 2,
                            WebkitBoxOrient: "vertical",
                            lineHeight: "1.4em",
                          }}
                          dangerouslySetInnerHTML={{
                            __html: result.highlight || result.content_preview,
                          }}
                        ></div>
                      </div>

                      {/* Metadata - Compact */}
                      <div className="flex justify-between items-center text-xs text-gray-400 mt-2 pt-2 border-t">
                        <div className="flex space-x-3">
                          <span>
                            <i className="fas fa-list-ol mr-1"></i>
                            {result.line_count} lines
                          </span>
                          <span>
                            <i className="fas fa-brain mr-1"></i>
                            {result.complexity_score?.toFixed(1) || "0"}
                          </span>
                          {result.pagerank_score && (
                            <span>
                              <i className="fas fa-star mr-1"></i>
                              {result.pagerank_score.toFixed(2)}
                            </span>
                          )}
                        </div>
                        <span className="text-gray-500">
                          {result.modified_time
                            ? new Date(result.modified_time).toLocaleDateString()
                            : "N/A"}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* No Results */}
              {results.length === 0 && searchPerformed && !loading && (
                <div className="text-center py-8">
                  <i className="fas fa-search text-4xl text-gray-400 mb-4"></i>
                  <h3 className="text-lg font-medium text-gray-900 mb-2">
                    No results found
                  </h3>
                  <p className="text-gray-600">
                    Try adjusting your search terms or filters
                  </p>
                </div>
              )}

              {/* File Viewer Modal */}
              {fileViewerState.isOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] flex flex-col">
                    {/* Modal Header */}
                    <div className="flex items-center justify-between p-4 border-b flex-shrink-0">
                      <div className="flex-1">
                        <h2 className="text-lg font-semibold text-gray-900 truncate">
                          {fileViewerState.filename}
                        </h2>
                        <p className="text-sm text-gray-600 truncate">
                          {fileViewerState.filePath}
                        </p>
                      </div>
                      <div className="flex items-center space-x-2 ml-4">
                        {fileViewerState.metadata && (
                          <div className="text-xs text-gray-500 space-x-3">
                            <span>
                              <i className="fas fa-list-ol mr-1"></i>
                              {fileViewerState.metadata.line_count} lines
                            </span>
                            <span>
                              <i className="fas fa-file-alt mr-1"></i>
                              {fileViewerState.metadata.file_type}
                            </span>
                          </div>
                        )}
                        <button
                          onClick={closeFileViewer}
                          className="text-gray-400 hover:text-gray-600 p-1"
                        >
                          <i className="fas fa-times text-xl"></i>
                        </button>
                      </div>
                    </div>

                    {/* Modal Body */}
                    <div className="flex-1 overflow-hidden" style={{ minHeight: 0 }}>
                      {fileViewerState.loading ? (
                        <div className="flex items-center justify-center h-full">
                          <div className="text-center">
                            <i className="fas fa-spinner fa-spin text-2xl text-blue-600 mb-2"></i>
                            <p className="text-gray-600">
                              Loading file content...
                            </p>
                          </div>
                        </div>
                      ) : fileViewerState.error ? (
                        <div className="flex items-center justify-center h-full">
                          <div className="text-center text-red-600">
                            <i className="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Error loading file: {fileViewerState.error}</p>
                          </div>
                        </div>
                      ) : (
                        <div className="h-full overflow-hidden" style={{ maxHeight: '100%' }}>
                          <CodeViewer
                            content={fileViewerState.content}
                            filePath={fileViewerState.filePath}
                            hasSearchHighlights={fileViewerState.hasSearchHighlights}
                          />
                        </div>
                      )}
                    </div>

                    {/* Modal Footer */}
                    <div className="p-4 border-t bg-gray-50 flex justify-between items-center flex-shrink-0">
                      <div className="text-xs text-gray-500">
                        {fileViewerState.hasSearchHighlights && (
                          <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded mr-2">
                            <i className="fas fa-search mr-1"></i>
                            Search highlights active
                          </span>
                        )}
                        {fileViewerState.metadata && (
                          <span>
                            Last modified:{" "}
                            {new Date(
                              fileViewerState.metadata.modified_time
                            ).toLocaleString()}
                          </span>
                        )}
                      </div>
                      <button
                        onClick={closeFileViewer}
                        className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition-colors"
                      >
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // Render the app
        ReactDOM.render(<SearchApp />, document.getElementById("root"));
      {% endraw %}
    </script>
  </body>
</html>
